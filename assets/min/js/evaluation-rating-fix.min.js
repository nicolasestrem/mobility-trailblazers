/***Evaluation Rating Fix*Purpose: Fix the issue where only one rating can be selected across all categories*Issue #21: Evaluation page does not allow more than one rating across all categories*Created: 2025-08-18*Updated: 2025-08-19-Added proper button group handling*Updated: 2025-08-20-Fixed event handler conflicts with proper namespacing(.mt-evaluation)*/(function($){'use strict'; $(document).ready(function(){function initializeButtonGroups(){$('.mt-score-button').off('.mt-evaluation'); $(document).off('click.mt-evaluation', '.mt-score-button'); $('.mt-button-group').each(function(){var $group=$(this); var criterionKey=$group.data('criterion'); var $hiddenInput=$group.find('input[type="hidden"]'); $group.find('.mt-score-button').on('click.mt-evaluation', function(e){e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation(); var $button=$(this); var value=$button.data('value'); $group.find('.mt-score-button').removeClass('active selected'); $button.addClass('active selected'); $hiddenInput.val(value); var $card=$group.closest('.mt-criterion-card'); $card.find('.mt-score-value').text(value); updateOverallScore(); if(typeof MTJuryDashboard !=='undefined' && MTJuryDashboard.updateTotalScore){MTJuryDashboard.updateTotalScore();}});});}function initializeIndependentSliders(){$('.mt-score-slider').off('.mt-evaluation'); $(document).off('input.mt-evaluation change.mt-evaluation', '.mt-score-slider'); $('.mt-score-slider').each(function(){var $slider=$(this); var sliderName=$slider.attr('name'); if(!sliderName){return;}$slider.off('change.mt-evaluation input.mt-evaluation'); $slider.on('input.mt-evaluation change.mt-evaluation', function(e){e.stopPropagation(); var value=$(this).val(); var $card=$(this).closest('.mt-criterion-card'); $card.find('.mt-score-value').text(value); var percentage=(value/10)*100; $(this).css('background', 'linear-gradient(to right, #667eea 0%, #667eea '+percentage+'%, #e5e7eb '+percentage+'%, #e5e7eb 100%)'); updateOverallScore();}); var initialValue=$slider.val(); var percentage=(initialValue/10)*100; $slider.css('background', 'linear-gradient(to right, #667eea 0%, #667eea '+percentage+'%, #e5e7eb '+percentage+'%, #e5e7eb 100%)');});}function fixScoreMarks(){$('.mt-score-mark').off('click.mt-evaluation'); $('.mt-score-mark').on('click.mt-evaluation', function(e){e.preventDefault(); e.stopPropagation(); var value=$(this).data('value'); var $card=$(this).closest('.mt-criterion-card'); var $slider=$card.find('.mt-score-slider'); $slider.val(value).trigger('input'); $(this).addClass('selected').siblings().removeClass('selected');});}function updateOverallScore(){var total=0; var count=0; $('.mt-score-slider').each(function(){var value=parseFloat($(this).val()); if(!isNaN(value)){total+=value; count++;}}); if(count===0){$('.mt-button-group').each(function(){var $hiddenInput=$(this).find('input[type="hidden"]'); var value=parseFloat($hiddenInput.val()); if(!isNaN(value)){total+=value; count++;}});}if(count > 0){var average=(total/count).toFixed(1); $('#mt-total-score').text(average); $('.mt-total-score-value').text(average); $('.mt-average-score').text(average+'/10'); $('.mt-evaluated-count').text('('+count+'/5 criteria evaluated)');}}function validateEvaluation(){$('#mt-evaluation-form').off('submit.mt-evaluation').on('submit.mt-evaluation', function(e){var allRated=true; var unratedCriteria=[]; $('.mt-score-slider').each(function(){var value=parseFloat($(this).val()); var name=$(this).attr('name'); if(isNaN(value)|| value===0){allRated=false; unratedCriteria.push(name.replace('_score', ''));}}); if(!allRated && unratedCriteria.length===5){e.preventDefault(); alert('Please rate at least one criterion before submitting.'); return false;}$('.mt-score-slider').each(function(){console.log($(this).attr('name')+': '+$(this).val());});});}function reinitializeAfterAjax(){$(document).off('ajaxComplete.mt-evaluation').on('ajaxComplete.mt-evaluation', function(event, xhr, settings){if(settings.url &&(settings.url.includes('evaluate')|| settings.url.includes('mt_get_candidate'))){setTimeout(function(){initializeIndependentSliders(); fixScoreMarks(); updateOverallScore();}, 100);}});}function addDebugInfo(){if(window.location.search.includes('debug=1')){var debugHtml='<div id="evaluation-debug" style="position:fixed;bottom:10px;right:10px;background:#fff;border:2px solid #000;padding:10px;z-index:9999;">'; debugHtml+='<h4>Evaluation Debug</h4>'; debugHtml+='<div id="debug-values"></div>'; debugHtml+='</div>'; $('body').append(debugHtml); setInterval(function(){var debugInfo=''; $('.mt-score-slider').each(function(){debugInfo+=$(this).attr('name')+': '+$(this).val()+'<br>';}); $('#debug-values').html(debugInfo);}, 1000);}}function initializeAllFixes(){setTimeout(function(){$('.mt-score-slider').off('.mt-evaluation'); $(document).off('input.mt-evaluation change.mt-evaluation', '.mt-score-slider'); $('.mt-score-button').off('.mt-evaluation'); $(document).off('click.mt-evaluation', '.mt-score-button'); $('.mt-score-mark').off('.mt-evaluation'); if($('.mt-button-group').length > 0){initializeButtonGroups();}if($('.mt-score-slider').length > 0){initializeIndependentSliders();}fixScoreMarks(); updateOverallScore(); validateEvaluation(); reinitializeAfterAjax(); addDebugInfo();}, 750);}initializeAllFixes(); $(window).off('load.mt-evaluation').on('load.mt-evaluation', function(){if($('.mt-score-slider').length > 0){initializeAllFixes();}}); window.MTEvaluationFix={reinitialize: initializeAllFixes, checkValues: function(){$('.mt-score-slider').each(function(){console.log($(this).attr('name')+': '+$(this).val());});}};});})(jQuery);
