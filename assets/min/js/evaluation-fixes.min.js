/***Critical JavaScript Fixes for Evaluation Form*Created: 2025-08-17*Purpose: Fix broken evaluation form functionality*/jQuery(document).ready(function($){'use strict'; function initializeSliders(){$('.mt-button-group').each(function(){var $buttonGroup=$(this); var criterion=$buttonGroup.data('criterion'); var currentValue=$buttonGroup.find('input[type="hidden"]').val()|| 5; var sliderHTML=` <div class="mt-score-slider-container"> <input type="range" name="${criterion}_score" class="mt-score-slider" min="0" max="10" step="0.5" value="${currentValue}" data-criterion="${criterion}"> <div class="mt-slider-value">${currentValue}</div> </div> `; $buttonGroup.replaceWith(sliderHTML);}); $('.mt-score-slider').on('input change', function(){var $slider=$(this); var value=$slider.val(); var $display=$slider.siblings('.mt-slider-value'); $display.text(value); var $card=$slider.closest('.mt-criterion-card'); $card.find('.mt-score-value').text(value); updateTotalScore();});}function updateTotalScore(){var total=0; var count=0; $('.mt-score-slider').each(function(){var value=parseFloat($(this).val()); if(!isNaN(value)){total+=value; count++;}}); var average=count > 0 ?(total/count).toFixed(1): 0; $('#mt-total-score').text(average); updateScoreIndicator(average);}function updateScoreIndicator(score){var $indicator=$('.mt-total-score-display'); $indicator.removeClass('score-low score-medium score-high'); if(score < 4){$indicator.addClass('score-low');}else if(score < 7){$indicator.addClass('score-medium');}else{$indicator.addClass('score-high');}}function fixBiographyDisplay(){var $bioContent=$('.mt-bio-content'); if($bioContent.length && $bioContent.text().trim()===''){var bioText=$bioContent.data('biography')|| $('#candidate-biography').val()|| $('.mt-candidate-bio-hidden').text(); if(bioText && bioText.trim()!==''){$bioContent.html('<p>'+bioText+'</p>');}else{$bioContent.html('<p class="no-content">No biography available for this candidate.</p>');}}}function fixFormSubmission(){$('#mt-evaluation-form').on('submit', function(e){e.preventDefault(); var $form=$(this); var formData=new FormData(this); formData.append('action', 'mt_save_evaluation'); $('.mt-score-slider').each(function(){var name=$(this).attr('name'); var value=$(this).val(); formData.set(name, value);}); var $submitBtn=$form.find('button[type="submit"]'); var originalText=$submitBtn.html(); $submitBtn.prop('disabled', true).html('<span class="dashicons dashicons-update spin"></span> Submitting...'); $.ajax({url: mt_ajax.ajax_url, type: 'POST', data: formData, processData: false, contentType: false, success: function(response){if(response.success){showNotification('success', response.data.message ||(mt_frontend && mt_frontend.i18n && mt_frontend.i18n.evaluation_submitted ? mt_frontend.i18n.evaluation_submitted : 'Bewertung erfolgreich abgeschickt!')); updateStatusBadge('completed'); setTimeout(function(){window.location.href=response.data.redirect || window.location.href.split('?')[0];}, 2000);}else{showNotification('error', response.data ||(mt_frontend && mt_frontend.i18n && mt_frontend.i18n.error_try_again ? mt_frontend.i18n.error_try_again : 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.')); $submitBtn.prop('disabled', false).html(originalText);}}, error: function(){showNotification('error', mt_frontend && mt_frontend.i18n && mt_frontend.i18n.network_error ? mt_frontend.i18n.network_error : 'Netzwerkfehler. Bitte überprüfen Sie Ihre Verbindung und versuchen Sie es erneut.'); $submitBtn.prop('disabled', false).html(originalText);}});});}function showNotification(type, message){$('.mt-notification').remove(); var $notification=$('<div class="mt-notification mt-notification-'+type+'">'+'<span class="dashicons dashicons-'+(type==='success' ? 'yes' : 'warning')+'"></span> '+message+'</div>'); $('body').append($notification); setTimeout(function(){$notification.addClass('show');}, 100); setTimeout(function(){$notification.removeClass('show'); setTimeout(function(){$notification.remove();}, 300);}, 5000);}function updateStatusBadge(status){var $badge=$('.mt-status-badge'); if($badge.length===0){$badge=$('<span class="mt-status-badge"></span>'); $('.mt-evaluation-title').append($badge);}$badge.removeClass('mt-status-draft mt-status-completed').addClass('mt-status-'+status); if(status==='draft'){$badge.text('Draft Saved');}else if(status==='completed'){$badge.text('Evaluation Submitted');}}function initCharacterCount(){var $textarea=$('#mt-comments'); var $counter=$('#mt-char-current'); var maxLength=1000; function updateCount(){var length=$textarea.val().length; $counter.text(length); if(length > maxLength){$counter.parent().addClass('over-limit');}else{$counter.parent().removeClass('over-limit');}}$textarea.on('input keyup', updateCount); updateCount();}function addMissingStyles(){if($('#mt-critical-fixes-styles').length===0){var styles=` <style id="mt-critical-fixes-styles"> .mt-score-slider-container{position: relative; margin: 20px 0;}.mt-score-slider{width: 100%; height: 6px;-webkit-appearance: none; appearance: none; background: #ddd; border-radius: 3px; outline: none;}.mt-score-slider::-webkit-slider-thumb{-webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #4CAF50; border-radius: 50%; cursor: pointer;}.mt-score-slider::-moz-range-thumb{width: 20px; height: 20px; background: #4CAF50; border-radius: 50%; cursor: pointer; border: none;}.mt-slider-value{position: absolute; top:-25px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;}.mt-total-score-display{float: right; font-size: 1.2em; font-weight: bold; padding: 5px 10px; border-radius: 5px; background: #f0f0f0;}.mt-total-score-display.score-low{background: #ffebee; color: #c62828;}.mt-total-score-display.score-medium{background: #fff3e0; color: #ef6c00;}.mt-total-score-display.score-high{background: #e8f5e9; color: #2e7d32;}.mt-notification{position: fixed; top: 50px; right:-300px; background: white; padding: 15px 20px; border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 9999; transition: right 0.3s ease; max-width: 300px;}.mt-notification.show{right: 20px;}.mt-notification-success{border-left: 4px solid #4CAF50; color: #2e7d32;}.mt-notification-error{border-left: 4px solid #f44336; color: #c62828;}.mt-char-count{text-align: right; font-size: 0.9em; color: #666; margin-top: 5px;}.mt-char-count.over-limit{color: #f44336; font-weight: bold;}.dashicons.spin{animation: spin 1s linear infinite;}@keyframes spin{from{transform: rotate(0deg);}to{transform: rotate(360deg);}}.mt-bio-content:empty::before{content: "Biography information not available."; color: #999; font-style: italic;}.no-content{color: #999; font-style: italic;}</style> `; $('head').append(styles);}}function initializeFixes(){addMissingStyles(); initializeSliders(); updateTotalScore(); fixBiographyDisplay(); fixFormSubmission(); initCharacterCount();}if($('.mt-evaluation-form, #mt-evaluation-form').length > 0){initializeFixes();}$(document).ajaxComplete(function(event, xhr, settings){if(settings.url && settings.url.includes('evaluate')){setTimeout(initializeFixes, 100);}});});
